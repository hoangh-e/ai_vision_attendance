<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üñ•Ô∏è BHK Tech - Desktop Monitoring</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .nav-tabs .nav-link.active {
            background-color: #007bff;
            color: white;
        }
        .tab-content {
            padding: 20px;
            border: 1px solid #dee2e6;
            border-top: none;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .connection-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .connection-indicator.connected { background-color: #2ecc71; }
        .connection-indicator.disconnected { background-color: #e74c3c; }
        .detection-card {
            border-left: 4px solid #3498db;
            margin-bottom: 10px;
        }
        .detection-card.employee { border-left-color: #2ecc71; }
        .detection-card.stranger { border-left-color: #e74c3c; }
        .mobile-viewer {
            background: #000;
            border-radius: 10px;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center my-4">üñ•Ô∏è BHK Tech - H·ªá Th·ªëng ƒêi·ªÉm Danh</h1>
                
                <!-- Connection Status -->
                <div class="alert alert-info text-center" id="connectionAlert">
                    <span class="connection-indicator disconnected" id="connectionIndicator"></span>
                    <span id="connectionText">ƒêang k·∫øt n·ªëi t·ªõi server...</span>
                </div>
            </div>
        </div>
        
        <ul class="nav nav-tabs" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="monitor-tab" data-bs-toggle="tab" data-bs-target="#monitor" type="button" role="tab">
                    üì± Monitor Mobile
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="management-tab" data-bs-toggle="tab" data-bs-target="#management" type="button" role="tab">
                    üë• Qu·∫£n l√Ω nh√¢n vi√™n
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="capture-tab" data-bs-toggle="tab" data-bs-target="#capture" type="button" role="tab">
                    üì∑ Ch·ª•p ·∫£nh t·ª´ laptop
                </button>
            </li>
        </ul>

        <div class="tab-content" id="mainTabContent">
            <!-- Tab 1: Mobile Monitoring -->
            <div class="tab-pane fade show active" id="monitor" role="tabpanel">
                <div class="row">
                    <div class="col-md-8">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3>üì± Mobile Stream Viewer</h3>
                            <div>
                                <button id="toggleDetectionBtn" class="btn btn-primary">üîç B·∫≠t Face Detection</button>
                                <button id="refreshStatsBtn" class="btn btn-outline-secondary">üîÑ Refresh</button>
                            </div>
                        </div>
                        
                        <div class="mobile-viewer" id="mobileViewer">
                            <div class="text-center">
                                <h4>üì± Ch·ªù k·∫øt n·ªëi t·ª´ Mobile</h4>
                                <p>Truy c·∫≠p <strong>http://[YOUR_IP]:5000/mobile</strong> tr√™n ƒëi·ªán tho·∫°i</p>
                                <div class="mt-3">
                                    <small class="text-muted">
                                        üí° L·∫•y IP m√°y t√≠nh: <code>ipconfig</code> (Windows) ho·∫∑c <code>ifconfig</code> (Mac/Linux)
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Live Stats -->
                        <div class="row mt-3">
                            <div class="col-md-3">
                                <div class="stats-card text-center">
                                    <h5>üìä Frames</h5>
                                    <h2 id="totalFrames">0</h2>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stats-card text-center">
                                    <h5>üë§ Detections</h5>
                                    <h2 id="totalDetections">0</h2>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stats-card text-center">
                                    <h5>‚ö° FPS</h5>
                                    <h2 id="currentFPS">0</h2>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stats-card text-center">
                                    <h5>üì± Clients</h5>
                                    <h2 id="connectedClients">0</h2>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <h3>üîç Detection Results</h3>
                        <div class="card">
                            <div class="card-body">
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="detectionToggle">
                                    <label class="form-check-label" for="detectionToggle">
                                        Face Detection Active
                                    </label>
                                </div>
                                <div id="detectionResults">
                                    <p class="text-muted">Ch∆∞a c√≥ k·∫øt qu·∫£ ph√°t hi·ªán...</p>
                                </div>
                            </div>
                        </div>
                        
                        <h4 class="mt-4">üì± Connected Devices</h4>
                        <div id="connectedDevices" class="card">
                            <div class="card-body">
                                <p class="text-muted">Ch∆∞a c√≥ thi·∫øt b·ªã k·∫øt n·ªëi...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 2: Employee Management (Same as before but cleaner) -->
            <div class="tab-pane fade" id="management" role="tabpanel">
                <div class="row">
                    <div class="col-md-4">
                        <h3>üë§ Th√™m nh√¢n vi√™n m·ªõi</h3>
                        <form id="employeeForm" class="card p-3">
                            <div class="mb-3">
                                <label for="name" class="form-label">H·ªç t√™n *</label>
                                <input type="text" class="form-control" id="name" required>
                            </div>
                            <div class="mb-3">
                                <label for="employee_code" class="form-label">M√£ nh√¢n vi√™n *</label>
                                <input type="text" class="form-control" id="employee_code" required>
                            </div>
                            <div class="mb-3">
                                <label for="department" class="form-label">Ph√≤ng ban</label>
                                <input type="text" class="form-control" id="department">
                            </div>
                            <div class="mb-3">
                                <label for="position" class="form-label">Ch·ª©c v·ª•</label>
                                <input type="text" class="form-control" id="position">
                            </div>
                            <div class="mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email">
                            </div>
                            <div class="mb-3">
                                <label for="phone" class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                                <input type="tel" class="form-control" id="phone">
                            </div>
                            <button type="submit" class="btn btn-primary w-100">‚ûï Th√™m nh√¢n vi√™n</button>
                        </form>
                    </div>
                    
                    <div class="col-md-8">
                        <h3>üìã Danh s√°ch nh√¢n vi√™n</h3>
                        <div class="table-responsive">
                            <table class="table table-striped" id="employeeTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>M√£ NV</th>
                                        <th>H·ªç t√™n</th>
                                        <th>Ph√≤ng ban</th>
                                        <th>S·ªë ·∫£nh</th>
                                        <th>Thao t√°c</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Modal qu·∫£n l√Ω ·∫£nh -->
                <div class="modal fade" id="imageModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">üì∏ Qu·∫£n l√Ω ·∫£nh nh√¢n vi√™n</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label for="imageUpload" class="form-label">üì§ T·∫£i ·∫£nh l√™n</label>
                                    <input type="file" class="form-control" id="imageUpload" accept="image/*" multiple>
                                    <div class="form-text">T·ªëi ƒëa 10 ·∫£nh cho m·ªói nh√¢n vi√™n</div>
                                </div>
                                <div id="imageGallery" class="row"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 3: Laptop Capture -->
            <div class="tab-pane fade" id="capture" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <h3>üì∑ Ch·ª•p ·∫£nh t·ª´ Laptop</h3>
                        <div class="card p-3">
                            <div class="mb-3">
                                <label for="captureEmployeeSelect" class="form-label">Ch·ªçn nh√¢n vi√™n</label>
                                <select id="captureEmployeeSelect" class="form-select">
                                    <option value="">-- Ch·ªçn nh√¢n vi√™n --</option>
                                </select>
                            </div>
                            
                            <div id="captureSection" style="display: none;">
                                <h5>üé• Camera laptop</h5>
                                <video id="laptopVideo" width="100%" height="300" autoplay style="border: 1px solid #ccc; border-radius: 8px;"></video>
                                <div class="text-center mt-3">
                                    <button id="captureBtn" class="btn btn-primary btn-lg">üì∏ Ch·ª•p ·∫£nh</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div id="capturePreview" style="display: none;">
                            <h4>üñºÔ∏è ·∫¢nh ƒë√£ ch·ª•p</h4>
                            <div class="card">
                                <canvas id="captureCanvas" width="100%" height="300" style="border-radius: 8px;"></canvas>
                                <div class="card-body text-center">
                                    <button id="saveCaptureBtn" class="btn btn-success">üíæ L∆∞u ·∫£nh</button>
                                    <button id="retakeBtn" class="btn btn-secondary">üîÑ Ch·ª•p l·∫°i</button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="captureStatus" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        // =====================================================
        // GLOBAL VARIABLES & INITIALIZATION
        // =====================================================
        let socket;
        let currentEmployeeId = null;
        let laptopStream = null;
        let detectionActive = false;
        let stats = {
            totalFrames: 0,
            totalDetections: 0,
            currentFPS: 0,
            connectedClients: 0
        };

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            connectToServer();
            loadEmployees();
            setupEventListeners();
        });

        // =====================================================
        // SOCKET.IO CONNECTION & EVENTS
        // =====================================================
        function connectToServer() {
            socket = io();
            
            socket.on('connect', function() {
                console.log('‚úÖ Connected to server');
                updateConnectionStatus(true);
                
                // Register as desktop monitor
                socket.emit('register_desktop_monitor', {
                    settings: {
                        auto_detection: detectionActive,
                        display_mode: 'real-time'
                    },
                    client_info: {
                        type: 'desktop',
                        timestamp: new Date().toISOString()
                    }
                });
            });

            socket.on('disconnect', function() {
                console.log('‚ùå Disconnected from server');
                updateConnectionStatus(false);
            });

            socket.on('desktop_monitor_joined', function(data) {
                console.log('üñ•Ô∏è Desktop monitor joined:', data);
                updateStats(data.stats);
                updateConnectedClients(data.connected_clients);
                detectionActive = data.detection_active;
                updateDetectionUI();
            });

            socket.on('mobile_connected', function(data) {
                console.log('üì± Mobile connected:', data);
                updateConnectedClients(data.client_count);
                showMobileConnected();
            });

            socket.on('frame_processed', function(data) {
                console.log('üé¨ Frame processed:', data);
                updateStats({
                    totalFrames: data.total_frames,
                    totalDetections: data.detections_count
                });
            });

            socket.on('detection_status_changed', function(data) {
                detectionActive = data.active;
                updateDetectionUI();
            });

            socket.on('stats_update', function(data) {
                updateStats(data.stats);
                updateConnectedClients(data.connected_clients);
            });

            // üé• Handle video frame updates from mobile
            socket.on('video_frame_update', function(data) {
                console.log('üìπ Received video frame from mobile');
                displayMobileVideoFrame(data);
            });

            // ‚≠ê KEY FIX: Missing event handler for desktop
            socket.on('mobile_frame_received', function(data) {
                console.log('üìπ Received frame from mobile:', data);
                displayVideoFrameOnDesktop(data);
            });

            // üì± Handle mobile client connections
            socket.on('mobile_client_connected', function(data) {
                console.log('üì± Mobile client connected:', data);
                showMobileConnected();
            });

            // üîÑ Handle detection state changes
            socket.on('detection_state_changed', function(data) {
                detectionActive = data.detection_active;
                updateDetectionUI();
                console.log('üîç Detection state changed:', data.detection_active);
            });

            // ‚úÖ Handle desktop registration confirmation
            socket.on('desktop_registration_confirmed', function(data) {
                console.log('üñ•Ô∏è Desktop registered successfully:', data);
                // Request current system status
                socket.emit('get_system_status');
            });
        }

        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('connectionIndicator');
            const text = document.getElementById('connectionText');
            const alert = document.getElementById('connectionAlert');
            
            if (connected) {
                indicator.className = 'connection-indicator connected';
                text.textContent = 'ƒê√£ k·∫øt n·ªëi t·ªõi server';
                alert.className = 'alert alert-success text-center';
            } else {
                indicator.className = 'connection-indicator disconnected';
                text.textContent = 'M·∫•t k·∫øt n·ªëi t·ªõi server';
                alert.className = 'alert alert-danger text-center';
            }
        }

        // =====================================================
        // STATISTICS & UI UPDATES
        // =====================================================
        function updateStats(newStats) {
            stats = { ...stats, ...newStats };
            
            document.getElementById('totalFrames').textContent = stats.totalFrames || 0;
            document.getElementById('totalDetections').textContent = stats.totalDetections || 0;
            document.getElementById('currentFPS').textContent = stats.fps || 0;
        }

        function updateConnectedClients(count) {
            stats.connectedClients = count;
            document.getElementById('connectedClients').textContent = count;
            
            const devicesDiv = document.getElementById('connectedDevices');
            if (count > 0) {
                devicesDiv.innerHTML = `
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <span class="connection-indicator connected"></span>
                            <strong>${count} thi·∫øt b·ªã ƒëang k·∫øt n·ªëi</strong>
                        </div>
                        <small class="text-muted">ƒêang nh·∫≠n video stream t·ª´ mobile</small>
                    </div>
                `;
            } else {
                devicesDiv.innerHTML = `
                    <div class="card-body">
                        <p class="text-muted">Ch∆∞a c√≥ thi·∫øt b·ªã k·∫øt n·ªëi...</p>
                    </div>
                `;
            }
        }

        function showMobileConnected() {
            const viewer = document.getElementById('mobileViewer');
            viewer.innerHTML = `
                <div class="text-center">
                    <h4 class="text-success">‚úÖ Mobile ƒë√£ k·∫øt n·ªëi!</h4>
                    <p>ƒêang nh·∫≠n video stream real-time</p>
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            `;
        }

        // üé• Display mobile video frame on desktop
        function displayMobileVideoFrame(data) {
            const viewer = document.getElementById('mobileViewer');
            
            if (!data.frame) {
                console.warn('No frame data received');
                return;
            }

            // Create or update video display
            let videoImg = viewer.querySelector('#mobileVideoStream');
            
            if (!videoImg) {
                viewer.innerHTML = `
                    <div class="position-relative w-100 h-100">
                        <img id="mobileVideoStream" 
                             src="${data.frame}" 
                             class="w-100 h-100" 
                             style="object-fit: contain; border-radius: 10px;" 
                             alt="Mobile Video Stream">
                        <div class="position-absolute top-0 start-0 m-2">
                            <span class="badge bg-success">
                                <span class="connection-indicator connected"></span>
                                LIVE t·ª´ Mobile
                            </span>
                        </div>
                        <div class="position-absolute bottom-0 end-0 m-2">
                            <small class="badge bg-dark">
                                üéØ ${data.detections ? data.detections.length : 0} faces
                            </small>
                        </div>
                    </div>
                `;
                videoImg = viewer.querySelector('#mobileVideoStream');
            } else {
                // Update existing image
                videoImg.src = data.frame;
                
                // Update detection count
                const detectionBadge = viewer.querySelector('.badge.bg-dark');
                if (detectionBadge) {
                    detectionBadge.innerHTML = `üéØ ${data.detections ? data.detections.length : 0} faces`;
                }
            }

            // Update stats if detections found
            if (data.detections && data.detections.length > 0) {
                console.log(`üë• Detected ${data.detections.length} faces:`, data.detections);
                
                // Update global stats
                stats.totalDetections += data.detections.length;
                updateStatsDisplay();
            }

            // Update frame count
            stats.totalFrames++;
            updateStatsDisplay();
        }

        // ‚≠ê NEW FUNCTION: Display video frame on desktop (KEY FIX)
        function displayVideoFrameOnDesktop(data) {
            const videoContainer = document.getElementById('mobileViewer');
            if (!data.frame) {
                console.warn('No frame data in displayVideoFrameOnDesktop');
                return;
            }
            
            // Create or update video display
            let videoImg = videoContainer.querySelector('#mobileVideoStream');
            if (!videoImg) {
                videoContainer.innerHTML = `
                    <div class="position-relative w-100 h-100">
                        <img id="mobileVideoStream" src="${data.frame}" 
                             style="width: 100%; height: auto; border-radius: 10px;"
                             alt="Mobile Video Stream">
                        <div class="position-absolute top-0 start-0 m-2">
                            <span class="badge bg-success">üì± LIVE t·ª´ Mobile</span>
                        </div>
                        <div class="position-absolute bottom-0 end-0 m-2">
                            <small class="badge bg-dark">
                                üéØ ${data.detections ? data.detections.length : 0} faces
                            </small>
                        </div>
                    </div>
                `;
                console.log('‚úÖ Created new video display element');
            } else {
                videoImg.src = data.frame;
                
                // Update detection count
                const detectionBadge = videoContainer.querySelector('.badge.bg-dark');
                if (detectionBadge) {
                    detectionBadge.innerHTML = `üéØ ${data.detections ? data.detections.length : 0} faces`;
                }
                console.log('‚úÖ Updated existing video display');
            }

            // Update stats
            if (data.detections && data.detections.length > 0) {
                console.log(`üë• Desktop received ${data.detections.length} face detections`);
            }
        }

        function updateDetectionUI() {
            const toggle = document.getElementById('detectionToggle');
            const btn = document.getElementById('toggleDetectionBtn');
            
            toggle.checked = detectionActive;
            
            if (detectionActive) {
                btn.textContent = '‚è∏Ô∏è T·∫Øt Face Detection';
                btn.className = 'btn btn-warning';
            } else {
                btn.textContent = 'üîç B·∫≠t Face Detection';
                btn.className = 'btn btn-primary';
            }
        }

        // =====================================================
        // EVENT LISTENERS
        // =====================================================
        function setupEventListeners() {
            // Detection toggle
            document.getElementById('detectionToggle').addEventListener('change', function() {
                detectionActive = this.checked;
                socket.emit('toggle_detection', { active: detectionActive });
            });

            document.getElementById('toggleDetectionBtn').addEventListener('click', function() {
                detectionActive = !detectionActive;
                socket.emit('toggle_detection', { active: detectionActive });
            });

            // Refresh stats
            document.getElementById('refreshStatsBtn').addEventListener('click', function() {
                socket.emit('get_stats');
            });

            // Employee form
            document.getElementById('employeeForm').addEventListener('submit', handleEmployeeSubmit);
            
            // Image upload
            document.getElementById('imageUpload').addEventListener('change', handleImageUpload);
            
            // Capture functions
            document.getElementById('captureEmployeeSelect').addEventListener('change', handleCaptureEmployeeSelect);
            document.getElementById('captureBtn').addEventListener('click', captureImage);
            document.getElementById('saveCaptureBtn').addEventListener('click', saveCapturedImage);
            document.getElementById('retakeBtn').addEventListener('click', retakeImage);
        }

        // =====================================================
        // EMPLOYEE MANAGEMENT FUNCTIONS
        // =====================================================
        function loadEmployees() {
            fetch('/api/employees')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        populateEmployeeTable(data.data);
                        populateEmployeeSelect(data.data);
                    }
                });
        }

        function populateEmployeeTable(employees) {
            const tbody = document.querySelector('#employeeTable tbody');
            tbody.innerHTML = '';
            
            employees.forEach(emp => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><strong>${emp.employee_code}</strong></td>
                    <td>${emp.name}</td>
                    <td>${emp.department || 'N/A'}</td>
                    <td>
                        <span class="badge ${emp.image_count >= 10 ? 'bg-success' : 'bg-warning'}">${emp.image_count}/10</span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="manageImages(${emp.id}, '${emp.name}')">üì∏ Qu·∫£n l√Ω ·∫£nh</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteEmployee(${emp.id})">üóëÔ∏è X√≥a</button>
                    </td>
                `;
            });
        }

        function populateEmployeeSelect(employees) {
            const select = document.getElementById('captureEmployeeSelect');
            select.innerHTML = '<option value="">-- Ch·ªçn nh√¢n vi√™n --</option>';
            
            employees.forEach(emp => {
                if (emp.image_count < 10) {
                    const option = document.createElement('option');
                    option.value = emp.id;
                    option.textContent = `${emp.name} (${emp.image_count}/10 ·∫£nh)`;
                    select.appendChild(option);
                }
            });
        }

        function handleEmployeeSubmit(e) {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('name').value,
                employee_code: document.getElementById('employee_code').value,
                department: document.getElementById('department').value,
                position: document.getElementById('position').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value
            };
            
            fetch('/api/employees', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ Th√™m nh√¢n vi√™n th√†nh c√¥ng!');
                    e.target.reset();
                    loadEmployees();
                } else {
                    alert('‚ùå L·ªói: ' + data.error);
                }
            });
        }

        // =====================================================
        // IMAGE MANAGEMENT
        // =====================================================
        function manageImages(employeeId, employeeName) {
            currentEmployeeId = employeeId;
            document.querySelector('#imageModal .modal-title').textContent = `üì∏ Qu·∫£n l√Ω ·∫£nh - ${employeeName}`;
            
            loadEmployeeImages(employeeId);
            
            const modal = new bootstrap.Modal(document.getElementById('imageModal'));
            modal.show();
        }

        function loadEmployeeImages(employeeId) {
            // This would be implemented with the actual API endpoint
            fetch(`/api/employees/${employeeId}/vectors`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayImages(data.data);
                    }
                });
        }

        function displayImages(images) {
            const gallery = document.getElementById('imageGallery');
            gallery.innerHTML = '';
            
            images.forEach(img => {
                const col = document.createElement('div');
                col.className = 'col-md-3 mb-3';
                col.innerHTML = `
                    <div class="card">
                        <img src="/${img.image_path}" class="card-img-top" style="height: 150px; object-fit: cover;">
                        <div class="card-body p-2">
                            <button class="btn btn-sm btn-danger w-100" onclick="deleteImage(${img.id})">üóëÔ∏è X√≥a</button>
                        </div>
                    </div>
                `;
                gallery.appendChild(col);
            });
        }

        function handleImageUpload(e) {
            const files = e.target.files;
            for (let file of files) {
                uploadImage(file);
            }
        }

        function uploadImage(file) {
            const formData = new FormData();
            formData.append('image', file);
            
            fetch(`/api/employees/${currentEmployeeId}/upload`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadEmployeeImages(currentEmployeeId);
                    loadEmployees();
                } else {
                    alert('‚ùå L·ªói: ' + data.error);
                }
            });
        }

        // =====================================================
        // LAPTOP CAPTURE FUNCTIONS
        // =====================================================
        function handleCaptureEmployeeSelect() {
            const employeeId = this.value;
            if (employeeId) {
                currentEmployeeId = employeeId;
                startLaptopCamera();
                document.getElementById('captureSection').style.display = 'block';
            } else {
                stopLaptopCamera();
                document.getElementById('captureSection').style.display = 'none';
            }
        }

        function startLaptopCamera() {
            navigator.mediaDevices.getUserMedia({video: true})
                .then(stream => {
                    laptopStream = stream;
                    document.getElementById('laptopVideo').srcObject = stream;
                })
                .catch(err => {
                    alert('‚ùå Kh√¥ng th·ªÉ truy c·∫≠p camera: ' + err.message);
                });
        }

        function stopLaptopCamera() {
            if (laptopStream) {
                laptopStream.getTracks().forEach(track => track.stop());
                laptopStream = null;
            }
        }

        function captureImage() {
            const video = document.getElementById('laptopVideo');
            const canvas = document.getElementById('captureCanvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            
            document.getElementById('capturePreview').style.display = 'block';
        }

        function saveCapturedImage() {
            const canvas = document.getElementById('captureCanvas');
            const imageData = canvas.toDataURL('image/jpeg');
            
            // Convert to blob and upload
            canvas.toBlob(blob => {
                const formData = new FormData();
                formData.append('image', blob, 'capture.jpg');
                
                fetch(`/api/employees/${currentEmployeeId}/upload`, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    const status = document.getElementById('captureStatus');
                    if (data.success) {
                        status.innerHTML = `<div class="alert alert-success">‚úÖ L∆∞u ·∫£nh th√†nh c√¥ng!</div>`;
                        loadEmployees();
                        document.getElementById('capturePreview').style.display = 'none';
                    } else {
                        status.innerHTML = `<div class="alert alert-danger">‚ùå L·ªói: ${data.error}</div>`;
                    }
                });
            }, 'image/jpeg');
        }

        function retakeImage() {
            document.getElementById('capturePreview').style.display = 'none';
        }

        // Global functions for onclick handlers
        window.manageImages = manageImages;
        window.deleteEmployee = function(employeeId) {
            if (confirm('‚ùì B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a nh√¢n vi√™n n√†y?')) {
                fetch(`/api/employees/${employeeId}`, {method: 'DELETE'})
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            loadEmployees();
                        }
                    });
            }
        };
        window.deleteImage = function(vectorId) {
            if (confirm('‚ùì B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ·∫£nh n√†y?')) {
                fetch(`/api/vectors/${vectorId}`, {method: 'DELETE'})
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            loadEmployeeImages(currentEmployeeId);
                            loadEmployees();
                        }
                    });
            }
        };
    </script>
</body>
</html>